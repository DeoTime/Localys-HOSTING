# Fork: sync with upstream when upstream notifies via repository_dispatch (and keep polling/manual)
name: Sync upstream -> main (on upstream dispatch or schedule)

on:
  repository_dispatch:
    types: [upstream_push]
  workflow_dispatch:
  schedule:
    - cron: '*/5 * * * *' # fallback polling every 5 minutes (optional)

env:
  UPSTREAM_REPO: https://github.com/KadenLi6741/Localys.git
  DEFAULT_BRANCH: main

permissions:
  contents: write
  pull-requests: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.UPSTREAM_SYNC_PAT }}
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and fetch
        run: |
          git remote add upstream "${{ env.UPSTREAM_REPO }}" || true
          git fetch upstream --prune --tags

      - name: Ensure local default branch exists
        run: git checkout --progress --force ${{ env.DEFAULT_BRANCH }}

      - name: Try fast-forward merge from upstream
        id: try_ff
        run: |
          if git merge --ff-only upstream/${{ env.DEFAULT_BRANCH }}; then
            echo "status=ff" >> $GITHUB_OUTPUT
          else
            echo "status=no-ff" >> $GITHUB_OUTPUT
          fi

      - name: Push fast-forward to origin (if ff)
        if: steps.try_ff.outputs.status == 'ff'
        run: git push origin ${{ env.DEFAULT_BRANCH }}

      - name: Create sync branch from upstream and push (if non-ff)
        if: steps.try_ff.outputs.status == 'no-ff'
        id: create_branch
        run: |
          DATE=$(date -u +"%Y%m%d-%H%M%S")
          BRANCH="sync/upstream-${{ env.DEFAULT_BRANCH }}-${DATE}"
          git checkout -b "$BRANCH"
          git reset --hard upstream/${{ env.DEFAULT_BRANCH }}
          git push -u origin "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Create pull request (if non-ff)
        if: steps.try_ff.outputs.status == 'no-ff'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.UPSTREAM_SYNC_PAT }}
          commit-message: "Sync: update from upstream/${{ env.DEFAULT_BRANCH }}"
          title: "Sync: update from upstream/${{ env.DEFAULT_BRANCH }}"
          body: |
            This PR was automatically created to sync in changes from the upstream repository.
            Review and merge when ready.
          base: ${{ env.DEFAULT_BRANCH }}
          head: ${{ steps.create_branch.outputs.branch }}
          labels: automated, sync
